class ProductBundle extends HTMLElement{constructor(){super(),this.listItem=this.querySelectorAll(".bundle-product-item"),this.form=this.querySelector("form"),this.updateBundleTotalPrice(),this.updateBundleText(),this.form.addEventListener("change",this.onVariantChange.bind(this)),this.form.addEventListener("submit",this.onSubmitHandler.bind(this)),this.querySelector("[data-bundle-checkbox]")&&(this.querySelectorAll("[data-bundle-checkbox]").forEach(e=>{e.addEventListener("click",this.onHandleCheckedProduct.bind(this))}),document.body.addEventListener("click",this.onBodyClickEvent.bind(this))),this.querySelector(".bundle-product-toogle")&&(this.querySelectorAll(".bundle-product-toogle").forEach(e=>{e.addEventListener("click",this.onHandleToogleProduct.bind(this))}),document.body.addEventListener("click",this.onBodyClickEvent.bind(this))),this.querySelector(".bundle-option-close")&&this.querySelectorAll(".bundle-option-close").forEach(e=>{e.addEventListener("click",this.onHandleCloseProduct.bind(this))})}onVariantChange(e){this.changeSwatch(e),this.updateVariants(e)}onSubmitHandler(e){e.preventDefault();const r=this,t=r.querySelector("[data-bundle-addtocart]");var o=window.variantStrings.addingToCart;this.querySelector(".bundle-product-wrapper").classList.add("has-halo-block-loader");const i=this.querySelectorAll(".bundle-product-item.isChecked"),n="FBT-BUNDLE-"+meta.product.id;let a="",l={};i.forEach((e,t)=>{e=e.querySelector("[name=group_id]").value;e&&(a=""+a+e+":1"+(t==i.length-1?"":","))}),$.post("/cart",function(e){t.value=o,l=e.attributes}).done(async function(){var e,t;try{await fetch("/cart/"+a),i.length==r.form.querySelectorAll(".bundle-product-item").length&&(e=parseFloat(r.querySelector("[data-bundle-discount-rate]").dataset.bundleDiscountRate),t=[...i].map(e=>parseInt(e.dataset.bundleProductItemId)),e=[{name:n,bundleDiscountRate:e,items:t}],t={...l,checkout_level_applications:e},e=JSON.stringify({attributes:t}),localStorage.setItem("storedDiscount",n),await fetch(""+routes.cart_update_url,{...fetchConfig(),body:e}),await fetch(`/discount/${n}?redirect=cart`)),r.querySelector(".bundle-product-wrapper").classList.remove("has-halo-block-loader"),r.redirectTo(window.routes.cart)}catch(e){console.error(e)}})}onHandleCheckedProduct(e){e.preventDefault();var t=e.currentTarget,e=e.target.closest(".bundle-product-item"),r=e.getAttribute("data-bundle-product-item-id");this.querySelector(`[data-bundle-product-item-id="${r}"]`).classList.contains("isChecked")?(this.querySelector(`[data-bundle-product-item-id="${r}"]`).classList.remove("isChecked"),e.classList.remove("isChecked"),t.previousElementSibling.removeAttribute("checked")):(this.querySelector(`[data-bundle-product-item-id="${r}"]`).classList.add("isChecked"),e.classList.add("isChecked"),t.previousElementSibling.setAttribute("checked",!0)),this.updateBundleTotalPrice()}onHandleToogleProduct(t){t.preventDefault(),this.listItem.forEach(e=>{!e.contains(t.target)||e.classList.contains("is-open")?e.classList.remove("is-open"):(e.classList.add("is-open"),this.updateVariants(t))})}onHandleCloseProduct(e){e.preventDefault(),e.currentTarget.closest(".bundle-product-item").classList.remove("is-open")}updateBundleText(e=!0){var t;e&&this.querySelector(".bundle-price")&&(e=100*this.querySelector(".bundle-price").getAttribute("data-bundle-discount-rate"),(t=this.querySelector(".bundle-product-text")).innerHTML=t.textContent.replace("[discount]",e),t.style.display="block")}updateBundleTotalPrice(e=!0){if(e){const i=this.querySelectorAll(".bundle-product-item.isChecked"),n=this.listItem.length;var o=0;this.querySelector(".bundle-price")&&(e=this.querySelector(".bundle-price"),this.querySelector(".bundle-old-price"),e.getAttribute("data-bundle-discount-rate")),0<i.length?i.forEach(e=>{var t=e.querySelector("select[name=group_id]"),r=e.querySelector("input[name=group_id]");(t=(t?t[t.selectedIndex]:r||e.querySelector("input[name=id]")).getAttribute("data-price"))&&(o+=parseFloat(t),this.querySelector(".bundle-price")&&(r=this.querySelector(".bundle-price"),e=this.querySelector(".bundle-old-price"),t=r.getAttribute("data-bundle-discount-rate"),r)&&e&&(e.innerHTML=Shopify.formatMoney(o,window.money_format),r.innerHTML=Shopify.formatMoney(o*(1-t),window.money_format),i.length==n?(r.style.display="inline-block",e.style.display="inline-block",this.querySelector("[data-bundle-product-total]").style.display="none"):(r.style.display="none",e.style.display="none",this.querySelector("[data-bundle-product-total]").style.display="block")),i.length==n?this.querySelector("[data-bundle-addtocart]").value=window.total_btn.add_all_item:2<i.length?this.querySelector("[data-bundle-addtocart]").value=window.total_btn.add_items.replace("[item]",i.length):this.querySelector("[data-bundle-addtocart]").value=window.total_btn.add_item.replace("[item]",i.length),this.querySelector("[data-bundle-product-total]").innerHTML=Shopify.formatMoney(o,window.money_format))}):(this.querySelector("[data-bundle-addtocart]").value=window.total_btn.add_item.replace("[item]",i.length),this.querySelector("[data-bundle-product-total]").innerHTML=Shopify.formatMoney(o,window.money_format))}}updateVariants(e){var t=e.target.closest(".bundle-product-item").getAttribute("data-bundle-product-item-id");const i=window.productVariants[t];t=e.target.closest(".bundle-product-item").querySelectorAll(".swatch");let n,a;i&&(t[0]&&(n=Array.from(t[0].querySelectorAll("input")).find(e=>e.checked).value),t[1]&&(a=Array.from(t[1].querySelectorAll("input")).find(e=>e.checked).value),t[2]&&Array.from(t[2].querySelectorAll("input")).find(e=>e.checked).value,t.forEach(e=>{var o,t=parseInt(e.getAttribute("data-option-idx"));o=t,e.querySelectorAll(".swatch-element").forEach(e=>{const t=e.getAttribute("data-value");var r=i.find(e=>{switch(o){case 0:return e.option1==t&&e.available;case 1:return e.option1==n&&e.option2==t&&e.available;case 2:return e.option1==n&&e.option2==a&&e.option3==t&&e.available}});i.find(e=>{switch(o){case 0:return e.option1==t;case 1:return e.option1==n&&e.option2==t;case 2:return e.option1==n&&e.option2==a&&e.option3==t}});e=e,null==r?(e.classList.add("soldout"),e.querySelector("input").setAttribute("disabled",!0)):(e.classList.remove("soldout"),e.querySelector("input").removeAttribute("disabled"))}),(t=e).querySelector("[data-header-option]").innerHTML=t.querySelector("input:checked").value}))}changeSwatch(e){var t=e.target.closest(".bundle-product-item"),r=Array.from(t.querySelectorAll(".swatch")),o=t.getAttribute("data-bundle-product-item-id"),i=window.productVariants[o],n=parseInt(e.target.closest("[data-option-idx]").getAttribute("data-option-idx")),a=Array.from(t.querySelectorAll(".swatch-element"));const l=e.target.value;var d,e=t.querySelector(".bundle-product-price"),c=(e.querySelector(".price-sale"),e.querySelector(".old-price")),e=e.querySelector("[data-bundle-product-price]"),u=t.querySelector("[name=group_id]"),s=t.querySelector(".bundle-hotStock");let p,h,y;switch(r[0]&&(h=Array.from(r[0].querySelectorAll("input")).find(e=>e.checked).value),r[1]&&(y=Array.from(r[1].querySelectorAll("input")).find(e=>e.checked).value),r[2]&&Array.from(r[2].querySelectorAll("input")).find(e=>e.checked).value,a.forEach(e=>{e.classList.remove("soldout"),e.querySelector("input").setAttribute("disabled",!1)}),n){case 0:var b=i.find(e=>e.option1==l&&e.option2==y&&e.available);p=null!=b?b:i.find(e=>e.option1==l&&e.available);break;case 1:null!=(b=i.find(e=>e.option1==h&&e.option2==l&&e.available))?p=b:console.log("Bundle Error: variant was soldout, on option selection #2");break;case 2:null!=(b=i.find(e=>e.option1==h&&e.option2==y&&e.option3==l&&e.available))?p=b:console.log("Bundle Error: variant was soldout, on option selection #3")}u.value=p.id,e.innerHTML=Shopify.formatMoney(p.price,window.money_format),p.compare_at_price>p.price?(e.classList.add("special-price"),c&&(c.innerHtml=Shopify.formatMoney(p.compare_at_price,window.money_format),c.style.display="inline-block")):(c&&(c.style.display="none"),e.classList.remove("special-price")),t.querySelector("select").value=p.id,this.updateBundleTotalPrice(),null!=p.inventory_management&&s&&(r=window["bundle_inven_array_"+o],a=parseInt(s.getAttribute("data-bundle-hot-stock")),null!=r&&(n=r[p.id],d=parseInt(n)),0<d&&d<=a?(u=window.inventory_text.hotStock.replace("[inventory]",d),s.innerText=u,s.style.display="block"):s.style.display="none"),p.featured_image&&((c=this.querySelector(`[data-bundle-product-item-id="${o}"] img`)).setAttribute("src",p.featured_image.src),c.setAttribute("srcset",p.featured_image.src)),this.checkNeedToConvertCurrency()&&Currency.convertAll(window.shop_currency,$("#currencies .active").attr("data-currency"),"span.money","money_format")}onBodyClickEvent(t){this.querySelector(".bundle-product-item.is-open")&&this.listItem.forEach(e=>{e.contains(t.target)||e.classList.remove("is-open")})}isRunningInIframe(){try{return window.self!==window.top}catch(e){return!0}}redirectTo(e){this.isRunningInIframe()&&!window.iframeSdk?window.top.location=e:window.location=e}checkNeedToConvertCurrency(){return window.show_multiple_currencies&&Currency.currentCurrency!=shopCurrency||window.show_auto_currency}}customElements.define("product-bundle",ProductBundle);