class PredictiveSearch extends HTMLElement{constructor(){super(),this.cachedResults={},this.input=this.querySelector('input[type="search"]'),this.predictiveSearchResults=this.querySelector("[data-predictive-search]"),this.trendingAndProductsBlock=this.querySelector("[data-quick-trending-products]"),this.closeStickySearchButton=document.querySelector(".header-search-close"),this.productToShow=this.dataset.productToShow,this.searchDetails=this.querySelector("details.search_details"),this.isOpen=!1,this.setupEventListeners()}setupEventListeners(){this.querySelector("form.search").addEventListener("submit",this.onFormSubmit.bind(this)),this.input.addEventListener("input",debounce(e=>{this.onChange(e)},500).bind(this)),this.input.addEventListener("focus",this.onFocus.bind(this)),this.addEventListener("focusout",this.onFocusOut.bind(this)),this.addEventListener("keyup",this.onKeyup.bind(this)),this.addEventListener("keydown",this.onKeydown.bind(this)),document.addEventListener("click",this.onDocClick.bind(this)),this.closeStickySearchButton.addEventListener("click",this.onCloseStickySearchClick.bind(this))}getQuery(){return this.input.value.trim()}onChange(){var e=this.getQuery();e.length?this.getSearchResults(e):this.close(!0)}onFormSubmit(e){this.getQuery().length&&!this.querySelector('[aria-selected="true"] a')||e.preventDefault()}onFocus(){var e=this.getQuery();if(!e.length)return this.showTrendingAndProducts();"true"===this.getAttribute("results")?this.open():this.getSearchResults(e)}onFocusOut(){setTimeout(()=>{this.contains(document.activeElement)||(this.close(),this.hideTrendingAndProducts())})}onKeyup(e){switch(this.getQuery().length||(this.close(!0),this.showTrendingAndProducts()),e.preventDefault(),e.code){case"ArrowUp":this.switchOption("up");break;case"ArrowDown":this.switchOption("down");break;case"Enter":this.selectOption()}}onKeydown(e){"ArrowUp"!==e.code&&"ArrowDown"!==e.code||e.preventDefault()}switchOption(t){if(this.getAttribute("open")){var t="up"===t,s=this.querySelector('[aria-selected="true"]'),i=this.querySelectorAll("li");let e=this.querySelector("li");t&&!s||(this.statusElement.textContent="",!t&&s?e=s.nextElementSibling||i[0]:t&&(e=s.previousElementSibling||i[i.length-1]),e!==s&&(e.setAttribute("aria-selected",!0),s&&s.setAttribute("aria-selected",!1),this.setLiveRegionText(e.textContent),this.input.setAttribute("aria-activedescendant",e.id)))}}selectOption(){var e=this.querySelector('[aria-selected="true"] a, [aria-selected="true"] button');e&&e.click()}getSearchResults(t){const s=t.replace(" ","-").toLowerCase();this.setLiveRegionLoadingState(),this.cachedResults[s]?(this.renderSearchResults(this.cachedResults[s]),this.updateViewAllLink(t)):fetch(`${routes.predictive_search_url}?q=${encodeURIComponent(t)}&${encodeURIComponent("resources[type]")}=product&${encodeURIComponent("resources[limit]")}=${this.productToShow}&section_id=predictive-search`).then(e=>{if(e.ok)return e.text();throw e=new Error(e.status),this.close(),e}).then(e=>{e=(new DOMParser).parseFromString(e,"text/html").querySelector("#shopify-section-predictive-search").innerHTML;this.cachedResults[s]=e,this.renderSearchResults(e),this.updateViewAllLink(t)}).catch(e=>{throw this.close(),e})}setLiveRegionLoadingState(){this.statusElement=this.statusElement||this.querySelector(".predictive-search-status"),this.loadingText=this.loadingText||this.getAttribute("data-loading-text"),this.setLiveRegionText(this.loadingText),this.setAttribute("loading",!0)}setLiveRegionText(e){this.statusElement.setAttribute("aria-hidden","false"),this.statusElement.textContent=e,setTimeout(()=>{this.statusElement.setAttribute("aria-hidden","true")},1e3)}renderSearchResults(e){this.predictiveSearchResults.innerHTML=e,this.setAttribute("results",!0),this.setLiveRegionResults(),this.open(),this.hideTrendingAndProducts()}setLiveRegionResults(){this.removeAttribute("loading"),this.setLiveRegionText(this.querySelector("[data-predictive-search-live-region-count-value]").textContent)}getResultsMaxHeight(){return this.resultsMaxHeight=window.innerHeight-document.querySelector('[id^="shopify-section-header"]').getBoundingClientRect().bottom,this.resultsMaxHeight}open(){this.predictiveSearchResults.style.maxHeight=this.resultsMaxHeight||this.getResultsMaxHeight()+"px",this.setAttribute("open",!0),this.input.setAttribute("aria-expanded",!0),this.isOpen=!0,this.searchDetails.setAttribute("open",!0)}close(e=!1){e&&(this.input.value="",this.removeAttribute("results"));e=this.querySelector('[aria-selected="true"]');e&&e.setAttribute("aria-selected",!1),this.input.setAttribute("aria-activedescendant",""),this.removeAttribute("open"),this.input.setAttribute("aria-expanded",!1),this.resultsMaxHeight=!1,this.predictiveSearchResults.removeAttribute("style"),this.isOpen=!1,this.searchDetails.removeAttribute("open",!0)}showTrendingAndProducts(){this.trendingAndProductsBlock&&(this.trendingAndProductsBlock.classList.add("is-show"),this.trendingAndProductsBlock.classList.remove("hidden"))}hideTrendingAndProducts(){this.trendingAndProductsBlock&&(this.trendingAndProductsBlock.classList.remove("is-show"),this.trendingAndProductsBlock.classList.add("hidden"))}onDocClick(e){let t;e.target.matches(".header-search-popup-close")||e.target.matches(".header-search-close")?t=e.target:e.target.closest(".header-search-popup-close")?t=e.target.closest(".header-search-popup-close"):e.target.closest(".header-search-close")&&(t=e.target.closest(".header-search-close")),this.contains(e.target)&&!t||(this.close(),this.hideTrendingAndProducts())}onCloseStickySearchClick(){this.close(),this.hideTrendingAndProducts(),document.querySelector("body").classList.remove("sticky-search-open")}updateViewAllLink(e){const t=document.querySelector("[data-qs-view-all-link]");if(t)return e=`${routes.search_url}?q=${encodeURIComponent(e)}&${encodeURIComponent("resources[type]")}=product`,t.href=e,this.getTotalResults(e).then(e=>{t.innerHTML=t.innerHTML.replace("()",`(${e})`)})}getTotalResults(e){return fetch(e).then(e=>{if(e.ok)return e.text();throw e=new Error(e.status),this.close(),e}).then(e=>{return(new DOMParser).parseFromString(e,"text/html").querySelector('[id^="SearchSection"]').dataset.searchCount}).catch(e=>{throw this.close(),e})}}customElements.define("predictive-search",PredictiveSearch);