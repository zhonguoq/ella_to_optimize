class ProductCombo extends HTMLElement{constructor(){super(),this.listItem=this.querySelectorAll(".bundle-product-item"),this.form=this.querySelector("form.combo-form"),this.selectContainers=this.querySelectorAll("[data-select-container]"),this.addComboButton=this.querySelector("[data-combo-addtocart]"),this.updateBundleTotalPrice(),this.updateBundleText(),this.form.addEventListener("change",this.onVariantChange.bind(this)),this.form.addEventListener("submit",this.onSubmitHandler.bind(this)),this.querySelector(".bundle-product-wrapper").classList.remove("has-halo-block-loader"),this.selectContainers&&(this.selectContainers.forEach(t=>{t.addEventListener("click",()=>{t.classList.contains("active")?t.classList.remove("active"):(this.selectContainers.forEach(e=>{e.classList.remove("active")}),t.classList.add("active"))}),t.querySelectorAll(".combo-item-label").forEach(e=>{e.addEventListener("click",()=>{t.classList.remove("active")})})}),document.addEventListener("click",e=>{null==e.target.closest("[data-select-container]")&&this.selectContainers.forEach(e=>{e.classList.remove("active")})})),this.listItem.forEach(e=>{this.updateVariants(e)})}onVariantChange(e){this.changeSwatch(e),this.updateVariants(e),this.checkSelectVariants()}onSubmitHandler(e){e.preventDefault(),this.querySelector(".bundle-product-wrapper").classList.add("has-halo-block-loader"),this.addComboButton.value=window.variantStrings.addingToCart;const i=this.querySelectorAll(".bundle-product-item.isChecked"),l="COMBO-"+meta.product.id;let c="",s={};Shopify.getCart(e=>{const n=e.items;i.forEach((t,o)=>{const r=t.querySelector("[name=group_id]").value;if(r){let e=0;t=n.find(e=>e.id===parseInt(r));null!=t&&(e=t.quantity),c=""+c+r+":"+(e+1)+(o==i.length-1?"":",")}if(o===i.length-1){const e=async()=>{var e=parseFloat(this.dataset.comboDiscountRate),t=[...i].map(e=>parseInt(e.dataset.bundleProductItemId)),e=[{name:l,bundleDiscountRate:e,items:t}],t={...s,checkout_level_applications:e},e=JSON.stringify({attributes:t});return localStorage.setItem("storedDiscount",l),fetch(""+routes.cart_update_url,{...fetchConfig(),body:e})},a=async()=>{i.length==this.form.querySelectorAll(".bundle-product-item").length&&await fetch(`/discount/${l}?redirect=/cart`)};$.post("/cart",()=>{}).done(async()=>{try{await fetch("/cart/"+c),await e(),await a(),this.addComboButton.value=window.variantStrings.addedToCart,this.addComboButton.disabled=!0,this.redirectTo(window.routes.cart)}catch(e){console.error(e),this.addComboButton.value=window.variantStrings.addToCart}finally{this.querySelector(".bundle-product-wrapper").classList.remove("has-halo-block-loader")}})}})})}updateBundleText(e=!0){e&&document.querySelector(".bundle-price-in-main")&&document.querySelector(".bundle-price-in-main").getAttribute("data-bundle-discount-rate")}updateBundleTotalPrice(e=!0){if(e){const a=this.querySelectorAll(".bundle-product-item.isChecked"),n=this.listItem.length;var r=0;this.querySelector(".bundle-price-in-main")&&(e=document.querySelector(".bundle-price-in-main"),document.querySelector(".bundle-old-price-in-main"),e.getAttribute("data-bundle-discount-rate")),0<a.length?a.forEach(e=>{var t=e.querySelector("select[name=group_id]"),o=e.querySelector("input[name=group_id]");(t=(t?t[t.selectedIndex]:o||e.querySelector("input[name=id]")).getAttribute("data-price"))&&(r+=parseFloat(t),document.querySelector(".bundle-price-in-main")&&(o=document.querySelector(".bundle-price-in-main"),e=document.querySelector(".bundle-old-price-in-main"),t=o.getAttribute("data-bundle-discount-rate"),o)&&e&&(e.innerHTML=Shopify.formatMoney(r,window.money_format),o.innerHTML=Shopify.formatMoney(r*(1-t),window.money_format),a.length==n?(o.style.display="inline-block",e.style.display="inline-block",document.querySelector("[data-combo-product-total]").style.display="none"):(o.style.display="none",e.style.display="none",document.querySelector("[data-combo-product-total]").style.display="block")),document.querySelector("[data-combo-product-total]").innerHTML=Shopify.formatMoney(r,window.money_format))}):(this.querySelector("[data-combo-addToCart]").value=window.total_btn.add_item.replace("[item]",a.length),document.querySelector("[data-combo-product-total]").innerHTML=Shopify.formatMoney(r,window.money_format))}}updateVariants(e){var e=e?.target?.closest(".bundle-product-item")||e,t=e.getAttribute("data-bundle-product-item-id");const a=window.productVariants[t];t=e.querySelectorAll(".swatch");let n,i;a&&(t[0]&&(n=Array.from(t[0].querySelectorAll("input")).find(e=>e.checked).value),t[1]&&(i=Array.from(t[1].querySelectorAll("input")).find(e=>e.checked).value),t[2]&&Array.from(t[2].querySelectorAll("input")).find(e=>e.checked).value,t.forEach(e=>{var r,t,o=parseInt(e.getAttribute("data-option-idx"));r=o,e.querySelectorAll(".swatch-element").forEach(e=>{const t=e.getAttribute("data-value");var o=a.find(e=>{switch(r){case 0:return e.option1==t&&e.available;case 1:return e.option1==n&&e.option2==t&&e.available;case 2:return e.option1==n&&e.option2==i&&e.option3==t&&e.available}});a.find(e=>{switch(r){case 0:return e.option1==t;case 1:return e.option1==n&&e.option2==t;case 2:return e.option1==n&&e.option2==i&&e.option3==t}});o=o,(e=e).parentElement.classList.contains("select-options"),null==o?(e.classList.add("soldout"),e.querySelector("input").setAttribute("disabled",!0)):(e.classList.remove("soldout"),e.querySelector("input").removeAttribute("disabled"))}),(t=e).querySelectorAll("[data-header-option]").forEach(e=>{e.innerHTML=t.querySelector("input:checked").value})}))}checkSelectVariants(){this.selectContainers.forEach(e=>{var t=e.querySelector(".combo-item-label:not(.soldout):not(:disabled)"),o=e.querySelector("[data-header-option]").innerText;![...e.querySelectorAll(".select-options .swatch-element")].filter(e=>!e.classList.contains("soldout")&&!e.disabled).map(e=>e.dataset.value).includes(o)&&t&&t.click()})}changeSwatch(e){var t=e.target.closest(".bundle-product-item"),o=Array.from(t.querySelectorAll(".swatch")),r=t.getAttribute("data-bundle-product-item-id"),a=window.productVariants[r],n=parseInt(e.target.closest("[data-option-idx]").getAttribute("data-option-idx")),i=Array.from(t.querySelectorAll(".swatch-element"));const l=e.target.value;var c,e=t.querySelector(".bundle-product-price"),s=(e.querySelector(".price-sale"),e.querySelector(".old-price")),e=e.querySelector("[data-bundle-product-price]"),d=t.querySelector("[name=group_id]"),u=t.querySelector(".bundle-hotStock");let p,m,y;switch(o[0]&&(m=Array.from(o[0].querySelectorAll("input")).find(e=>e.checked).value),o[1]&&(y=Array.from(o[1].querySelectorAll("input")).find(e=>e.checked).value),o[2]&&Array.from(o[2].querySelectorAll("input")).find(e=>e.checked).value,i.forEach(e=>{e.classList.remove("soldout"),e.querySelector("input").setAttribute("disabled",!1)}),n){case 0:var h=a.find(e=>e.option1==l&&e.option2==y&&e.available);p=null!=h?h:a.find(e=>e.option1==l&&e.available);break;case 1:null!=(h=a.find(e=>e.option1==m&&e.option2==l&&e.available))?p=h:console.log("Bundle Error: variant was soldout, on option selection #2");break;case 2:null!=(h=a.find(e=>e.option1==m&&e.option2==y&&e.option3==l&&e.available))?p=h:console.log("Bundle Error: variant was soldout, on option selection #3")}null!=p&&(d.value=p?.id,e.innerHTML=Shopify.formatMoney(p.price,window.money_format),p.compare_at_price>p.price?(e.classList.add("special-price"),s&&(s.innerHtml=Shopify.formatMoney(p.compare_at_price,window.money_format),s.style.display="block")):(s&&(s.style.display="none"),e.classList.remove("special-price")),t.querySelector("select").value=p.id,this.updateBundleTotalPrice(),null!=p.inventory_management&&u&&(o=window["bundle_inven_array_"+r],i=parseInt(u.getAttribute("data-bundle-hot-stock")),null!=o&&(n=o[p.id],c=parseInt(n)),0<c&&c<=i?(d=window.inventory_text.hotStock.replace("[inventory]",c),u.innerText=d,u.style.display="block"):u.style.display="none"),p.featured_image&&((s=this.querySelector(`[data-bundle-product-item-id="${r}"] img`)).setAttribute("src",p.featured_image.src),s.setAttribute("srcset",p.featured_image.src)),this.checkNeedToConvertCurrency())&&Currency.convertAll(window.shop_currency,$("#currencies .active").attr("data-currency"),"span.money","money_format")}onBodyClickEvent(t){this.querySelector(".bundle-product-item.is-open")&&this.listItem.forEach(e=>{e.contains(t.target)||e.classList.remove("is-open")})}isRunningInIframe(){try{return window.self!==window.top}catch(e){return!0}}redirectTo(e){this.isRunningInIframe()&&!window.iframeSdk?window.top.location=e:window.location=e}checkNeedToConvertCurrency(){return window.show_multiple_currencies&&Currency.currentCurrency!=shopCurrency||window.show_auto_currency}}window.addEventListener("load",()=>{customElements.define("product-combo",ProductCombo)});